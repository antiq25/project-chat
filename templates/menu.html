<script src="../static/js/socket.io.min.js"></script>
<script>
    const socket = io.connect(location.origin);
        socket.on("connect", () => {
            socket.emit("join", { user_id: "{{ current_user.id }}" });
        });

  </script>
<style>
  #notificationDot {
    position: relative;
    display: block;
    top: 10px; /* Adjust to fit your design */
    right: 10px; /* Adjust to fit your design */
      width: 10px;
      height: 10px;
      border-radius: 50; /* Makes it a circle */
    }
    
    

    .hidden {
      display: none;
    }
    
    .show {
      display: block !important;
    }


  </style>



  
  <div class="menu">
    <div class="menu-item dropdown">
    <a href="#" data-toggle-class="app-header-menu-search-toggled" data-toggle-target=".app" class="menu-link">
      <div class="menu-icon"><i class="bi bi-search nav-icon"></i></div>
    </a>
  </div>
  <div class="menu-item dropdown dropdown-mobile-full">
    <a href="#" data-bs-toggle="dropdown" data-bs-display="static" class="menu-link">
      <div class="menu-icon"><i class="bi bi-grid-3x3-gap nav-icon"></i></div>
    </a>
    <div class="dropdown-menu fade dropdown-menu-end w-300px text-center p-0 mt-1">
      <div class="row row-grid gx-0">
        <div class="col-4">
          <a href="email_inbox.html" class="dropdown-item text-decoration-none p-3 bg-none">
            <div class="position-relative">
              <i class="bi bi-circle-fill position-absolute text-theme top-0 mt-n2 me-n2 fs-6px d-block text-center w-100"></i>
              <i class="bi bi-envelope h2 opacity-5 d-block my-1"></i>
            </div>
            <div class="fw-500 fs-10px text-inverse">INBOX</div>
          </a>
        </div>
        <div class="col-4">
          <a href="pos_customer_order.html" target="_blank" class="dropdown-item text-decoration-none p-3 bg-none">
            <div><i class="bi bi-hdd-network h2 opacity-5 d-block my-1"></i></div>
            <div class="fw-500 fs-10px text-inverse">POS SYSTEM</div>
          </a>
        </div>
        <div class="col-4">
          <a href="calendar.html" class="dropdown-item text-decoration-none p-3 bg-none">
            <div><i class="bi bi-calendar4 h2 opacity-5 d-block my-1"></i></div>
              <div class="fw-500 fs-10px text-inverse">CALENDAR</div>
            </a>
          </div>
        </div>
        <div class="row row-grid gx-0">
          <div class="col-4">
            <a href="helper.html" class="dropdown-item text-decoration-none p-3 bg-none">
              <div><i class="bi bi-terminal h2 opacity-5 d-block my-1"></i></div>
              <div class="fw-500 fs-10px text-inverse">HELPER</div>
            </a>
          </div>
          <div class="col-4">
            <a href="settings.html" class="dropdown-item text-decoration-none p-3 bg-none">
              <div class="position-relative">
                <i class="bi bi-circle-fill position-absolute text-theme top-0 mt-n2 me-n2 fs-6px d-block text-center w-100"></i>
                <i class="bi bi-sliders h2 opacity-5 d-block my-1"></i>
              </div>
              <div class="fw-500 fs-10px text-inverse">SETTINGS</div>
            </a>
          </div>
          <div class="col-4">
            <a href="widgets.html" class="dropdown-item text-decoration-none p-3 bg-none">
              <div><i class="bi bi-collection-play h2 opacity-5 d-block my-1"></i></div>
              <div class="fw-500 fs-10px text-inverse">WIDGETS</div>
            </a>
          </div>
        </div>
      </div>
    </div>
    <div class="menu-item dropdown dropdown-mobile-full">
      <a href="#" data-bs-toggle="dropdown" data-bs-display="static" class="menu-link">
        <span id="notificationDot" onclick="hideDot()" style="display:none;">â€¢</span>
        <span id="notificationCount"></span>
        <div class="menu-icon"><i class="bi bi-bell nav-icon"></i></div>
        <div class="dropdown-menu dropdown-menu-end mt-1 w-300px fs-11px pt-1">
          <h6 class="dropdown-header fs-10px mb-1">NOTIFICATIONS</h6>
          <div class="dropdown-divider mt-1"></div>
          <div href="#" class="d-flex align-items-center py-10px dropdown-item text-wrap fw-semibold">
            <div class="fs-20px">
              <i class="bi bi-bag text-theme"></i>
              <div id="notificationList"></div>
            </a>
          </div>
        </div>
        <div class="dropdown-divider mt-1"></div>
      </div>
    </div>
    <div class="menu-item dropdown dropdown-mobile-full">
      <a href="#" data-bs-toggle="dropdown" data-bs-display="static" class="menu-link">
        <div class="menu-img online">
          <img src="../static/uploads/default_image.png" alt="Profile" height="60">
        </div>
        <div class="menu-text d-sm-block d-none w-170px"><span class="__cf_email__" data-cfemail="70050315021e111d15301113131f051e045e131f1d"></span></div>
      </a>
      <div class="dropdown-menu dropdown-menu-end me-lg-3 fs-11px mt-1">
        <a class="dropdown-item d-flex align-items-center" href="/profile">PROFILE <i class="bi bi-person-circle ms-auto text-theme fs-16px my-n1"></i></a>
        <a class="dropdown-item d-flex align-items-center" href="email_inbox.html">INBOX <i class="bi bi-envelope ms-auto text-theme fs-16px my-n1"></i></a>
        <a class="dropdown-item d-flex align-items-center" href="calendar.html">CALENDAR <i class="bi bi-calendar ms-auto text-theme fs-16px my-n1"></i></a>
        <a class="dropdown-item d-flex align-items-center" href="settings.html">SETTINGS <i class="bi bi-gear ms-auto text-theme fs-16px my-n1"></i></a>
        <div class="dropdown-divider"></div>
        <a class="dropdown-item d-flex align-items-center" href="/logout">LOGOUT <i class="bi bi-toggle-off ms-auto text-theme fs-16px my-n1"></i></a>
      </div>
    </div>
  </div>
  
  <form class="menu-search" method="POST" name="header_search_form">
    <div class="menu-search-container">
      <div class="menu-search-icon"><i class="bi bi-search"></i></div>
      <div class="menu-search-input">
        <input type="text" class="form-control form-control-lg" placeholder="Search menu...">
      </div>
      <div class="menu-search-icon">
        <a href="#" data-toggle-class="app-header-menu-search-toggled" data-toggle-target=".app"><i class="bi bi-x-lg"></i></a>
      </div>
    </div>
  </form>
  
</div>

<div id="sidebar" class="app-sidebar">
  <!-- ... Your current navigation ... -->

  <button onclick="toggleChat()" class="btn btn-primary w-85 mb-3">Toggle Chat</button>

  <!-- Chat Content (Initially Hidden) -->
  <div id="chatContent" style="display: none;">
      <div class="menu-header">Online Users</div>
      <div id="onlineUsers" data-scrollbar="true" data-height="100%" class="ps">
          <!-- JavaScript will populate this with online users -->
      </div>
      <div id="privateChatContent" style="display: none;">
        <h3>Private Messages with <span id="receiverUsername"></span>:</h3>
        <div class="shadow-6" style="height: 400px; overflow-y: scroll;" id="private-messages">
          {% for message in private_messages %}
              <div class="widget-chat-content">
                  {% if message.profile_pic %}
                  <img src="{{ message.profile_pic }}" alt="Profile Picture" width="30" height="30" class="rounded-circle me-2">
                  {% endif %}
                  <div>
                      <strong>{{ message.display_name }}</strong>: {{ message.content }} 
                  </div>
              </div>
              {% endfor %}
          </div>
          <div class="my-4">
              <div id="chatbox-private">
                  <form id="private-chat-form" class="chatbox">
                      <div class="input-group">
                          <input type="text" id="private-message-input" placeholder="Type your message" class="input bi-input-cursor-text sp-input-container" style="resize: none;" rows="1"/>
                          <div class="input-group-append">
                              <button type="submit" class="btn btn-primary">Send</button>
                          </div>
                      </div>
                  </form>
                  <div class="text-center">
                      <a href="/" class="btn btn-secondary">Back to Global Chat</a>
                      <a href="/logout" class="btn btn-danger">Logout</a>
                  </div>
          </div>
      </div>  
  </div> 
  </div>
</div>



<!-- Your HTML code here -->

<!-- Your HTML code here -->

<script>
 let isChatOpen = false;
let receiverId = null;

function toggleChat() {
    const chatContent = document.getElementById('chatContent');
    if (isChatOpen) {
        chatContent.style.display = 'none';
        isChatOpen = false;
    } else {
        chatContent.style.display = 'block';
        isChatOpen = true;  // Fixed typo here
    }
}

function handlePrivateMessageSubmission(event) {
    event.preventDefault();
    const message = privateMessageInput.value.trim();
    if (message) {
        socket.emit('send_private_message', {
            sender_id: "{{ current_user.id }}",
            receiver_id: receiverId,
            message,
        });
        privateMessageInput.value = '';
    }
}

const privateMessageForm = document.getElementById('private-chat-form');
const privateMessageInput = document.getElementById('private-message-input');
const privateMessagesList = document.getElementById('private-messages');
if (!privateMessagesList) {
    console.error('privateMessagesList element not found!');
}


function appendMessageToChatbox(data) {
  const messageDiv = document.createElement('div');
messageDiv.className = 'd-flex align-items-center mb-2';

const strongElement = document.createElement('strong');
strongElement.textContent = data.display_name || data.from;

messageDiv.appendChild(strongElement);

const messageText = document.createTextNode(`: ${data.message}`);
messageDiv.appendChild(messageText);

privateMessagesList.appendChild(messageDiv);

}


socket.on('private_message', function (data) {
    console.log("Processing received private message:", data);
    if (!privateMessagesList) {
        console.error('privateMessagesList element not found!');
        return;
    }
    appendMessageToChatbox(data);
    scrollBottom();
});

const textNode = document.createTextNode("This is a test text node.");
privateMessagesList.appendChild(textNode);

privateMessagesList.style.display = 'none';
setTimeout(() => {
    privateMessagesList.style.display = 'block';
}, 0);



function scrollBottom() {
    const privateMessages = document.getElementById('private-messages');
    privateMessages.scrollTop = privateMessages.scrollHeight;
}

window.onload = function () {
    privateMessageInput.focus();
    scrollBottom();
};

privateMessageForm.removeEventListener('submit', handlePrivateMessageSubmission);
privateMessageForm.addEventListener('submit', handlePrivateMessageSubmission);

function openPrivateChat(userId, username) {
    receiverId = userId;
    const receiverUsername = document.getElementById('receiverUsername');
    if (receiverUsername) { // Check if the element exists
        receiverUsername.textContent = username;
    }

    // Fetch chat history
    fetch(`/chat_history/${userId}`)
    .then(response => response.json())
    .then(data => {
        // Clear existing messages
        privateMessagesList.innerHTML = '';

        // Populate chat with history
        data.forEach(message => {
            const messageElement = document.createElement('div');
            messageElement.classList.add('d-flex', 'align-items-center', 'mb-2');
            messageElement.innerHTML = `<strong>${message.username}</strong>: ${message.content}`;
            privateMessagesList.appendChild(messageElement);
        });
        scrollBottom();
    });

    document.getElementById('privateChatContent').style.display = 'block';
}



const userElements = document.querySelectorAll('.messenger-user');
userElements.forEach(function (element) {
    const userId = element.getAttribute('data-user-id');
    const username = element.textContent;
    element.addEventListener('click', function () {
        openPrivateChat(userId, username);
    });
});


socket.on('user_menu_opened', function () {
    if (isChatOpen) {
        document.getElementById('chatContent').style.display = 'none';
        isChatOpen = false;
    }
});

function showPrivateChat() {
    const privateChatContent = document.getElementById('privateChatContent');
    privateChatContent.style.display = 'block';
}

privateMessagesList.scrollTop = privateMessagesList.scrollHeight;


</script>

<script src="../static/js/userlist.js"></script>
<script src="../static/js/users_update.js"></script>
